<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="darksimplicity">
  <meta name="generator" content="Hugo 0.20.2" />
  
  
  <base href="https://jeqo.github.io/">
  <title>Scaling Kafka with Docker Containers</title>
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack-extended.min.css">
  <link rel="stylesheet" href="/css/style.min.css">  
  <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
</head>
<body>
  <div class="wrap">
    <div class="navbar">
        <ul class="navbar-list" style="float:right">
          <li class="navbar-item">
              <a class="navbar-link" href="https://jeqo.github.io/post/">Blog</a>
          </li><li class="navbar-item">
              <a class="navbar-link" href="https://jeqo.github.io/talk/">Talks</a>
          </li>
          
          <li class="navbar-item"><a class="navbar-link">|</a></li>
          
          <li class="navbar-item"><a class="navbar-link" href="https://jeqo.github.io/es/post/2017-01-15-scale-kafka-containers/">es</a></li>
          
        </ul>
        
    </div>
    <div class="header">
      <span style="font-size: 34px;">
        <a href="https://jeqo.github.io/">@jeqo</a>
      </span>
      <span style="font-size:12px;">&nbsp;&nbsp;|&nbsp;&nbsp;<i>back-end, integration, devops, etc.</i> </span>
    </div>

<div class="empty">&nbsp;</div>
  <div class="post-title">
    <a class="post-title-link" href="https://jeqo.github.io/post/2017-01-15-scale-kafka-containers/">Scaling Kafka with Docker Containers</a>
  </div>
      <div class="tags">tags:</br>
        <a class="tag-link" href="/tags/kafka">kafka </a><a class="tag-link" href="/tags/docker">docker </a>
    </div>
    <div class="content-full"><p>In this post I will show how to use Docker containers to create and scale
a Kafka cluster, and also how to create, scale and move <code>topics</code> inside
the cluster.</p>

<p></p>

<hr />

<p>Repository: <a href="https://github.com/jeqo/post-scale-kafka-containers">https://github.com/jeqo/post-scale-kafka-containers</a></p>

<hr />

<h1 id="single-node-cluster">Single-Node Cluster</h1>

<p>First of all, let&rsquo;s start with the most simple way to run Docker, that
could be useful for some development scenarios: <strong>Single-Node Cluster</strong></p>

<p>Apache Kafka architecture is based in 2 main components: The <em>Apache
Kafka server</em> itself, and the <em>Apache Zookeeper server</em> used for internal
coordination.</p>

<p>That&rsquo;s why a Kafka single-node cluster requires at least a
couple of processes.</p>

<p>If we talk in Container terms and practices, these processes should be
run in 2 different containers.</p>

<p>The easiest way to do this is defining these processes as
Docker Compose services is a <code>kafka-cluster/docker-compose.yml</code> file:</p>

<hr />

<p>I will use a couple of Docker images. These are fairly simple
and you can find their source code here:
<a href="https://github.com/jeqo/docker-image-apache-kafka">Apache Kafka</a>,
<a href="https://github.com/jeqo/docker-image-apache-zookeeper">Apache Zookeeper</a>, and
<a href="https://github.com/jeqo/docker-image-confluent-platform">Confluent Platform</a></p>

<hr />

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">version: <span style="color: #BA2121">&quot;2.1&quot;</span>
services:
  kafka:
    image: jeqo/apache-kafka:0.10.1.0-2.11
    links:
      - zookeeper
  zookeeper:
    image: jeqo/apache-zookeeper:3.4.8
</pre></div>


<p>This configuration defines 2 services: <code>kafka</code> and <code>zookeeper</code>. The <code>kafka</code>
service <code>link</code> and environment variable <code>ZOOKEEPER_CONNECT</code> configure the access
from <code>kafka</code> to <code>zookeeper</code> service.</p>

<p>If we try to start these configuration with <code>docker-compose up -d</code>,
Docker Compose will create a <code>network</code> where these service can communicate.</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">jeqo@jeqo-Oryx-Pro:.../single-node-kafka-cluster$ docker-compose up -d
Creating network <span style="color: #BA2121">&quot;kafkacluster_default&quot;</span> with the default driver
Creating kafkacluster_zookeeper_1
Creating kafkacluster_kafka_1
</pre></div>


<p>If you want to communicate with the cluster from your application&rsquo;s
docker-compose configuration, you can do it as follows:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">version: <span style="color: #BA2121">&quot;2.1&quot;</span>
services:
  kafka:
    image: jeqo/apache-kafka-client:0.10.1.0-2.11
    command: sleep infinity
    networks:
      - default
      - kafkacluster_default <span style="color: #408080; font-style: italic">#(2)</span>
networks: <span style="color: #408080; font-style: italic">#(1)</span>
  kafkacluster_default:
    external: true
</pre></div>


<p>Here we define first an <code>external network</code> called <code>singlenodekafkacluster_default</code>
that will give us access to the kafka cluster network. Then we add this network
to the service network.</p>

<p>To test our client, start it up running <code>docker-compose up -d</code> and then connect
to the cluster with the following command:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">$ docker-compose <span style="color: #008000">exec</span> kafka bash
<span style="color: #408080; font-style: italic"># bin/kafka-console-producer.sh --broker-list kafka:9092 --topic topic1</span>
<span style="color: #008000">test</span>
<span style="color: #408080; font-style: italic"># bin/kafka-topics.sh --zookeeper zookeeper:2181 --list      </span>
topic1
</pre></div>


<h1 id="multi-node-cluster">Multi-Node Cluster</h1>

<p>To scale a container using Docker Compose is as simple as using the <code>scale</code> command:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">docker-compose scale <span style="color: #19177C">kafka</span><span style="color: #666666">=</span>3
</pre></div>


<p>This will create 2 more containers:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">$ docker-compose scale <span style="color: #19177C">kafka</span><span style="color: #666666">=</span>3
Creating and starting kafkacluster_kafka_2 ... <span style="color: #008000; font-weight: bold">done</span>
Creating and starting kafkacluster_kafka_3 ... <span style="color: #008000; font-weight: bold">done</span>
</pre></div>


<p>You, as an application developer, only need to know one of the <code>broker</code> IPs, or use the service
name to connect to the cluster. As the documentation specifies, the client (eg. producer or consumer)
will use it only once to get the Kafka <code>broker</code> IPs from the same cluster. This means that
Kafka scaling will be transparent to your application.</p>

<p>To validate that all brokers are part of the cluster let&rsquo;s use Zookeeper client to check. From
client container:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">$ docker-compose <span style="color: #008000">exec</span> kafka bash
<span style="color: #408080; font-style: italic"># bin/zookeeper-shell.sh zookeeper:2181</span>
ls /brokers/ids
<span style="color: #666666">[</span>1003, 1002, 1001<span style="color: #666666">]</span>
</pre></div>


<h1 id="scaling-topics">Scaling Topics</h1>

<p>In Kafka, <code>Topics</code> are distributed in <code>Partitions</code>. <code>Partitions</code> allows <strong>scalability</strong>, enabling <code>Topics</code>
to fit in several nodes, and <strong>parallelism</strong>, allowing different instances from the same <code>Consumer Group</code> to
consume messages in parallel.</p>

<p>Apart from this, Kafka manage how this <code>Partitions</code> are replicated, to achieve high availability. In
this case, if you have many <code>replicas</code> from one <code>partition</code>, one will be the <code>leader</code> and there will
be zero o more <code>followers</code> spread on different nodes.</p>

<p>How do we configure this using this simple container configuration? Let&rsquo;s evaluate some scenarios:</p>

<h2 id="adding-new-topics-to-the-cluster">Adding new topics to the cluster</h2>

<p>Once you scale your cluster, Kafka won&rsquo;t use these new nodes unless new <code>topics</code> are created.</p>

<p>Let&rsquo;s test it following these steps:</p>

<ol>
<li>Start a single node cluster</li>
</ol>

<script type="text/javascript" src="https://asciinema.org/a/9xzqgicktaqhzp1fofjk9ejgm.js" id="asciicast-9xzqgicktaqhzp1fofjk9ejgm" async></script>

<ol>
<li>Then start client, create a topic <code>topic1</code>, and describe the topic to check the broker</li>
</ol>

<script type="text/javascript" src="https://asciinema.org/a/2schnuetb24mjx6txopew51hc.js" id="asciicast-2schnuetb24mjx6txopew51hc" async></script>

<ol>
<li>Scale your cluster to 3 nodes</li>
</ol>

<script type="text/javascript" src="https://asciinema.org/a/ahibdzz7xt67q53sc5ert6qdp.js" id="asciicast-ahibdzz7xt67q53sc5ert6qdp" async></script>

<ol>
<li>Add topics to occupy other brokers</li>
</ol>

<p>Using multiple partitions:</p>

<script type="text/javascript" src="https://asciinema.org/a/enq2czkpgdf0tbf3u6fwir3ml.js" id="asciicast-enq2czkpgdf0tbf3u6fwir3ml" async></script>

<p>Or using a replication factor:</p>

<script type="text/javascript" src="https://asciinema.org/a/f0u67h5ufiz4zkup84a1t8t5g.js" id="asciicast-f0u67h5ufiz4zkup84a1t8t5g" async></script>

<p>To decide what <code>replication factor</code> or how many <code>partitions</code> to use, depends
on your use case. This deserves its own blog post.</p>

<h2 id="expanding-topics-in-your-cluster">Expanding topics in your cluster</h2>

<p>Expanding topics in your cluster means move <code>topics</code> and <code>partitions</code> once
you have more <code>brokers</code> in your <code>cluster</code>, because, as show before,
your new <code>brokers</code> won&rsquo;t store any data, once they are created, unless
you create new <code>topics</code>.</p>

<p>You can do this 3 steps:</p>

<ol>
<li><p>Identify which topics do you want to move.</p></li>

<li><p>Generate a candidate reassignment. This could be done automatically, or
you can decide how to redistribute your topics.</p></li>

<li><p>Execute your reassignment plan.</p></li>
</ol>

<p>You can do this following the documentation here: <a href="http://kafka.apache.org/documentation/#basic_ops_cluster_expansion">http://kafka.apache.org/documentation/#basic_ops_cluster_expansion</a></p>

<p>The steps described in the documentation are automated a bit with Ansible:</p>

<p>Inside the <code>playbooks/prepare-reassignment.yml</code> file you have 2 variables:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">vars:
  topics:
    - topic1
  broker_list: 1003
</pre></div>


<p>This will prepare a recipe to move your topic <code>topic1</code> to <code>broker</code> with id <code>1003</code>.</p>

<script type="text/javascript" src="https://asciinema.org/a/c6332x8t7yumpj65ie4qudgem.js" id="asciicast-c6332x8t7yumpj65ie4qudgem" async></script>

<p>You can paste the JSON file generated into <code>playbooks/reassign-topic-plan.json</code></p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{
  <span style="color: #008000; font-weight: bold">&quot;version&quot;</span>:<span style="color: #666666">1</span>,
  <span style="color: #008000; font-weight: bold">&quot;partitions&quot;</span>:[{<span style="color: #008000; font-weight: bold">&quot;topic&quot;</span>:<span style="color: #BA2121">&quot;topic1&quot;</span>,<span style="color: #008000; font-weight: bold">&quot;partition&quot;</span>:<span style="color: #666666">0</span>,<span style="color: #008000; font-weight: bold">&quot;replicas&quot;</span>:[<span style="color: #666666">1003</span>]}]
}
</pre></div>


<p>And then run this plan with the another playbook: <code>playbooks/execute-reassignment.yml</code></p>

<script type="text/javascript" src="https://asciinema.org/a/99308.js" id="asciicast-99308" async></script>

<h1 id="confluent-platform-images">Confluent Platform images</h1>

<p>All these could be done in the same way with <a href="https://www.confluent.io/">Confluent Platform</a>.</p>

<p>There is a couple of directories <code>confluent-cluster</code> and <code>confluent-client</code> to test this out:</p>

<script type="text/javascript" src="https://asciinema.org/a/a446bixdfn3l8xqoiolmsmlqg.js" id="asciicast-a446bixdfn3l8xqoiolmsmlqg" async></script>

<p>Hope this post help you to understand Kafka <code>topics</code> and how <code>containers</code> can
help you to run clusters in seconds :)</p>

<p>And, you know, run &hellip;</p>

<p><blockquote class="twitter-tweet" data-lang="es"><p lang="en" dir="ltr">.<a href="https://twitter.com/apachekafka">@apachekafka</a> everywhere :) <a href="https://t.co/AcEmkRBCpv">pic.twitter.com/AcEmkRBCpv</a></p>&mdash; Gwen (Chen) Shapira (@gwenshap) <a href="https://twitter.com/gwenshap/status/777660752626851840">19 de septiembre de 2016</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p><div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'jeqoblog';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
        <div class="navbar">
        <ul class="navbar-list" style="...">
            
            <li class="navbar-item"><a class="navbar-link" href="https://github.com/jeqo/">GitHub</a></li>
            
            <li class="navbar-item"><a class="navbar-link" href="https://twitter.com/jeqo89">Twitter</a></li>
            
            <li class="navbar-item"><a class="navbar-link" href="index.xml">RSS</a></li>
            
        </ul>
    </div>
    <div class="copyright">
        <p>&copy; 2017. @jeqo. All rights reserved. </p>
    </div>
    
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-49047812-3', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</div>
</body>
</html>

