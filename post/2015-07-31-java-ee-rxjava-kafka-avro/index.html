<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="darksimplicity">
  <meta name="generator" content="Hugo 0.18.1" />
  
  
  <base href="https://jeqo.github.io/">
  <title>Integrate Java EE 7 and Kafka using Avro and RxJava</title>
  <link rel="stylesheet" href="/css/style.min.css">

  <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
</head>
<body>
  <div class="wrap">
    <div class="navbar">
        <ul class="navbar-list" style="float:right">
          
        </ul>
    </div>
    <div class="navbar">
        
        <ul class="navbar-list" style="float:right">
            
            <li class="navbar-item"><a class="navbar-link" href="https://jeqo.github.io/es/post/2015-07-31-java-ee-rxjava-kafka-avro/">es</a></li>
            
        </ul>
        
    </div>
    <div class="header"><span style="font-size: 34px;">
      <a href="https://jeqo.github.io/">@jeqo</a></span>
      <span style="font-size:12px;">&nbsp;&nbsp;|&nbsp;&nbsp;<i>back-end development, integration, devops, etc.</i> </span></div>

<div class="empty">&nbsp;</div>
  <div class="post-title">
    <a class="post-title-link" href="https://jeqo.github.io/post/2015-07-31-java-ee-rxjava-kafka-avro/">Integrate Java EE 7 and Kafka using Avro and RxJava</a>
  </div>
      <div class="tags">tags:</br>
        <a class="tag-link" href="/tags/java-ee">java ee </a><a class="tag-link" href="/tags/kafka">kafka </a><a class="tag-link" href="/tags/avro">avro </a><a class="tag-link" href="/tags/rx">rx </a>
    </div>
    <div class="content-full"><p>I decided to implement a naive integration between Java EE applications and
RxJava/Kafka/Avro, to publish and subscribe to events.</p>

<p>You can go directly to that <a href="https://github.com/jeqo/java-ee-rxjava-kafka-avro">code</a>, or check my approach:</p>

<p></p>

<h2 id="tl-dr">TL;DR</h2>

<p>I have been playing with <a href="http://kafka.apache.org/">Kafka</a> recently, seduced by its benefits (fast, scalable,
and durable event source) to spread event using Publish/Subscribe pattern.</p>

<p>I realized that Kafka APIs are still evolving and getting better, and it was not
easy to find an easy introduction related with the current released version.
I am using <strong>0.8.2.1 release</strong>.</p>

<p>I tested its APIs to <em>produce</em> and <em>subscribe</em> to messages using this <a href="https://github.com/mdkhanga/my-blog-code">tutorial</a></p>

<p>Kafka support 2 types of messages: <em>Strings</em> and <em>byte[]</em>. So, after testing sample
String messages, I required to send POJO as messages. I came out with
another interesting Apache project: <a href="https://avro.apache.org">Avro</a>.</p>

<p>Using Avro tutorials (<a href="https://avro.apache.org/docs/current/gettingstartedjava.html">https://avro.apache.org/docs/current/gettingstartedjava.html</a>) and
another sources (<a href="https://github.com/wpm/AvroExample">https://github.com/wpm/AvroExample</a>) I found how to Serialize/Deserialize POJO, but without
persisting files on disk, just keeping them as ByteStreams. So, now I have
Events, defined by <a href="https://avro.apache.org/docs/current/spec.html#schema_record">Avro schemas</a>, and Kafka APIs ready to publish and subscribe
to these events.</p>

<p>Finally, I wanted to add these cool features to my Java EE 7 apps. First,
using CDI was simple to inject Producer and publish messages when your application
produces events, but when it comes to consume events the approach is different.
You are no longer producing events, but working with &ldquo;streams&rdquo; of data. So, I
decided to use <a href="https://github.com/ReactiveX/RxJava">RxJava</a> that applies concepts as
<a href="http://reactivex.io/documentation/observable.html"><strong>Observables</strong></a> and <strong>Subscribers</strong> that
fits smoothly with my requirements: each Kafka topic will be &ldquo;observable&rdquo; stream and each
Consumer will subscribe to that &ldquo;observable&rdquo;. Let&rsquo;s check the code:</p>

<h2 id="sample-java-ee-app">Sample Java EE App</h2>

<p><a href="https://github.com/jeqo/java-ee-rxjava-kafka-avro/releases/tag/v0.0.1">Tag: v0.0.1</a></p>

<p>First step is just having a couple of RESTful services, implemented with JAX-RS:</p>

<ul>
<li>Clients Resource: List (GET) and Add (POST) Clients</li>
<li>Events Resource: List (GET) Client Added Events</li>
</ul>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #AA22FF">@Path</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;clients&quot;</span><span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ClientsResource</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">static</span> List<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;</span> clients <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ArrayList<span style="color: #666666">&lt;&gt;();</span>

    <span style="color: #AA22FF">@GET</span>
    <span style="color: #AA22FF">@Produces</span><span style="color: #666666">(</span>MediaType<span style="color: #666666">.</span><span style="color: #7D9029">APPLICATION_JSON</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">public</span> List<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;</span> <span style="color: #0000FF">getClients</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">return</span> clients<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@POST</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">addClient</span><span style="color: #666666">(</span>String client<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        clients<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>client<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>


<p>At this point, Clients Resource is implemented. So, how can I do to propagate
ClientAddedEvent and list them on Events resource?</p>

<h2 id="serializing-and-deserializing-events">Serializing and Deserializing Events</h2>

<p><a href="https://github.com/jeqo/java-ee-rxjava-kafka-avro/releases/tag/v0.0.2">Tag: v0.0.2</a></p>

<p>When I decided to use Kafka, I realized that I can only send String and Byte
Array messages, so Avro is able to serialize POJO into byte[] and vice versa:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">test</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    ClientAddedEvent event <span style="color: #666666">=</span> ClientAddedEvent<span style="color: #666666">.</span><span style="color: #7D9029">newBuilder</span><span style="color: #666666">()</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">setName</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;jeqo&quot;</span><span style="color: #666666">)</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">setCreated</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Date<span style="color: #666666">().</span><span style="color: #7D9029">getTime</span><span style="color: #666666">())</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">();</span>
    <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> eventSerialized <span style="color: #666666">=</span> serializer<span style="color: #666666">.</span><span style="color: #7D9029">serialize</span><span style="color: #666666">(</span>event<span style="color: #666666">);</span>
    ClientAddedEvent eventDeserialized <span style="color: #666666">=</span> deserializer<span style="color: #666666">.</span><span style="color: #7D9029">deserialize</span><span style="color: #666666">(</span>eventSerialized<span style="color: #666666">);</span>
    assertEquals<span style="color: #666666">(</span>event<span style="color: #666666">,</span> eventDeserialized<span style="color: #666666">);</span>
<span style="color: #666666">}</span>
</pre></div>


<p>ClientAddedEvent event is defined using Avro JSON format:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span>{
    <span style="color: #008000; font-weight: bold">&quot;namespace&quot;</span>: <span style="color: #BA2121">&quot;com.jeqo.samples.eventsource.event&quot;</span>,
    <span style="color: #008000; font-weight: bold">&quot;type&quot;</span>: <span style="color: #BA2121">&quot;record&quot;</span>,
    <span style="color: #008000; font-weight: bold">&quot;name&quot;</span>: <span style="color: #BA2121">&quot;ClientAddedEvent&quot;</span>,
    <span style="color: #008000; font-weight: bold">&quot;fields&quot;</span>: [
        {<span style="color: #008000; font-weight: bold">&quot;name&quot;</span>: <span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;type&quot;</span>: <span style="color: #BA2121">&quot;string&quot;</span>},
        {<span style="color: #008000; font-weight: bold">&quot;name&quot;</span>: <span style="color: #BA2121">&quot;created&quot;</span>, <span style="color: #008000; font-weight: bold">&quot;type&quot;</span>: <span style="color: #BA2121">&quot;long&quot;</span>}
    ]
}
</pre></div>


<p>Adding a Maven Plugin, you will generate <em>ClientAddedEvent</em> each time you build
your project:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">&lt;build&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;plugins&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;plugin&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;groupId&gt;</span>org.apache.avro<span style="color: #008000; font-weight: bold">&lt;/groupId&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;artifactId&gt;</span>avro-maven-plugin<span style="color: #008000; font-weight: bold">&lt;/artifactId&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;version&gt;</span>1.7.7<span style="color: #008000; font-weight: bold">&lt;/version&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;executions&gt;</span>
                <span style="color: #008000; font-weight: bold">&lt;execution&gt;</span>
                    <span style="color: #008000; font-weight: bold">&lt;phase&gt;</span>generate-sources<span style="color: #008000; font-weight: bold">&lt;/phase&gt;</span>
                    <span style="color: #008000; font-weight: bold">&lt;goals&gt;</span>
                        <span style="color: #008000; font-weight: bold">&lt;goal&gt;</span>schema<span style="color: #008000; font-weight: bold">&lt;/goal&gt;</span>
                    <span style="color: #008000; font-weight: bold">&lt;/goals&gt;</span>
                    <span style="color: #008000; font-weight: bold">&lt;configuration&gt;</span>
                        <span style="color: #008000; font-weight: bold">&lt;sourceDirectory&gt;</span>${project.basedir}/src/main/avro/<span style="color: #008000; font-weight: bold">&lt;/sourceDirectory&gt;</span>
                        <span style="color: #008000; font-weight: bold">&lt;outputDirectory&gt;</span>${project.basedir}/src/main/java/<span style="color: #008000; font-weight: bold">&lt;/outputDirectory&gt;</span>
                    <span style="color: #008000; font-weight: bold">&lt;/configuration&gt;</span>
                <span style="color: #008000; font-weight: bold">&lt;/execution&gt;</span>
            <span style="color: #008000; font-weight: bold">&lt;/executions&gt;</span>
        <span style="color: #008000; font-weight: bold">&lt;/plugin&gt;</span>
    <span style="color: #008000; font-weight: bold">&lt;/plugins&gt;</span>
<span style="color: #008000; font-weight: bold">&lt;/build&gt;</span>
</pre></div>


<p>To serialize Avro records, from POJO to Byte Array:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EventSerializer</span><span style="color: #666666">&lt;</span>T <span style="color: #008000; font-weight: bold">extends</span> SpecificRecordBase<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]</span> <span style="color: #0000FF">serialize</span><span style="color: #666666">(</span>T record<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">(</span>ByteArrayOutputStream out <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ByteArrayOutputStream<span style="color: #666666">())</span> <span style="color: #666666">{</span>
            Encoder encoder <span style="color: #666666">=</span> EncoderFactory<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">().</span><span style="color: #7D9029">binaryEncoder</span><span style="color: #666666">(</span>out<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">);</span>
            <span style="color: #008000; font-weight: bold">new</span> SpecificDatumWriter<span style="color: #666666">&lt;&gt;(</span>record<span style="color: #666666">.</span><span style="color: #7D9029">getSchema</span><span style="color: #666666">()).</span><span style="color: #7D9029">write</span><span style="color: #666666">(</span>record<span style="color: #666666">,</span> encoder<span style="color: #666666">);</span>
            encoder<span style="color: #666666">.</span><span style="color: #7D9029">flush</span><span style="color: #666666">();</span>
            <span style="color: #008000; font-weight: bold">return</span> out<span style="color: #666666">.</span><span style="color: #7D9029">toByteArray</span><span style="color: #666666">();</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IOException ex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> RuntimeException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Error serializing event&quot;</span><span style="color: #666666">,</span> ex<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>


<p>And to deserialize:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EventDeserializer</span><span style="color: #666666">&lt;</span>T <span style="color: #008000; font-weight: bold">extends</span> SpecificRecordBase<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">private</span> <span style="color: #008000; font-weight: bold">final</span> Class<span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> type<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #0000FF">EventDeserializer</span><span style="color: #666666">(</span>Class<span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> type<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">.</span><span style="color: #7D9029">type</span> <span style="color: #666666">=</span> type<span style="color: #666666">;</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> T <span style="color: #0000FF">deserialize</span><span style="color: #666666">(</span><span style="color: #B00040">byte</span><span style="color: #666666">[]</span> recordSerialized<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">new</span> SpecificDatumReader<span style="color: #666666">&lt;&gt;(</span>type<span style="color: #666666">).</span><span style="color: #7D9029">read</span><span style="color: #666666">(</span>
                    <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">,</span>
                    DecoderFactory<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">()</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">binaryDecoder</span><span style="color: #666666">(</span>recordSerialized<span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">null</span><span style="color: #666666">)</span>
            <span style="color: #666666">);</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>IOException ex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> RuntimeException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Error deserializing event&quot;</span><span style="color: #666666">,</span> ex<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>


<h2 id="publishing-and-consuming-events-from-kafka-rxjava">Publishing and Consuming Events from Kafka/RxJava</h2>

<p><a href="https://github.com/jeqo/java-ee-rxjava-kafka-avro/releases/tag/v0.0.3">Tag: v0.0.3</a></p>

<p>Now that Event serialization is done with Avro, let&rsquo;s publish and subscribe
those events on Kafka:</p>

<p>First, let&rsquo;s define a couple of interfaces, EventServer:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">EventServer</span><span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> Observable<span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> <span style="color: #0000FF">consume</span><span style="color: #666666">();</span>
<span style="color: #666666">}</span>
</pre></div>


<p>and EventProducer:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">interface</span> <span style="color: #0000FF; font-weight: bold">EventProducer</span><span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">publish</span><span style="color: #666666">(</span>T message<span style="color: #666666">);</span>
<span style="color: #666666">}</span>
</pre></div>


<p>Then, let&rsquo;s implement them with Kafka. I will focus on main functionality first:</p>

<p>To publish messages:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #AA22FF">@Override</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">publish</span><span style="color: #666666">(</span>T message<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #408080; font-style: italic">// Produce a new Kafka record</span>
    ProducerRecord<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]&gt;</span> data <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> ProducerRecord<span style="color: #666666">&lt;&gt;(</span>
            message<span style="color: #666666">.</span><span style="color: #7D9029">getClass</span><span style="color: #666666">().</span><span style="color: #7D9029">getSimpleName</span><span style="color: #666666">(),</span>
            serializer<span style="color: #666666">.</span><span style="color: #7D9029">serialize</span><span style="color: #666666">(</span>message<span style="color: #666666">)</span>
    <span style="color: #666666">);</span>

    <span style="color: #408080; font-style: italic">// Publish this new record, waiting for acknowledge from Kafka</span>
    Future<span style="color: #666666">&lt;</span>RecordMetadata<span style="color: #666666">&gt;</span> rs <span style="color: #666666">=</span> producerProvider<span style="color: #666666">.</span><span style="color: #7D9029">producer</span><span style="color: #666666">()</span>
            <span style="color: #666666">.</span><span style="color: #7D9029">send</span><span style="color: #666666">(</span>data<span style="color: #666666">,</span> <span style="color: #666666">(</span>RecordMetadata recordMetadata<span style="color: #666666">,</span> Exception e<span style="color: #666666">)</span> <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
                LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">log</span><span style="color: #666666">(</span>Level<span style="color: #666666">.</span><span style="color: #7D9029">INFO</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Received ack for partition={0} offset = {1}&quot;</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> Object<span style="color: #666666">[]{</span>recordMetadata<span style="color: #666666">.</span><span style="color: #7D9029">partition</span><span style="color: #666666">(),</span> recordMetadata<span style="color: #666666">.</span><span style="color: #7D9029">offset</span><span style="color: #666666">()});</span>
            <span style="color: #666666">});</span>

    <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
        RecordMetadata rm <span style="color: #666666">=</span> rs<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">();</span>

        LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">log</span><span style="color: #666666">(</span>Level<span style="color: #666666">.</span><span style="color: #7D9029">INFO</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Kafka Record Metadata: partition = {0} offset ={1}&quot;</span><span style="color: #666666">,</span> <span style="color: #008000; font-weight: bold">new</span> Object<span style="color: #666666">[]{</span>rm<span style="color: #666666">.</span><span style="color: #7D9029">partition</span><span style="color: #666666">(),</span> rm<span style="color: #666666">.</span><span style="color: #7D9029">offset</span><span style="color: #666666">()});</span>

    <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>InterruptedException <span style="color: #666666">|</span> ExecutionException e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        System<span style="color: #666666">.</span><span style="color: #7D9029">out</span><span style="color: #666666">.</span><span style="color: #7D9029">println</span><span style="color: #666666">(</span>e<span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>


<p>And on KafkaEventServer, to instantiate an RxJava observable:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #AA22FF">@Override</span>
<span style="color: #008000; font-weight: bold">public</span> Observable<span style="color: #666666">&lt;</span>T<span style="color: #666666">&gt;</span> <span style="color: #0000FF">consume</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
    <span style="color: #008000; font-weight: bold">return</span> Observable<span style="color: #666666">.</span><span style="color: #7D9029">create</span><span style="color: #666666">(</span>subscriber <span style="color: #666666">-&gt;</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">try</span> <span style="color: #666666">{</span>
            LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">log</span><span style="color: #666666">(</span>Level<span style="color: #666666">.</span><span style="color: #7D9029">INFO</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Preparing Server for Event {0}&quot;</span><span style="color: #666666">,</span> type<span style="color: #666666">.</span><span style="color: #7D9029">getName</span><span style="color: #666666">());</span>
            <span style="color: #408080; font-style: italic">// It will observe one Topic</span>
            Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Integer<span style="color: #666666">&gt;</span> topicCountMap <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;&gt;();</span>
            topicCountMap<span style="color: #666666">.</span><span style="color: #7D9029">put</span><span style="color: #666666">(</span>type<span style="color: #666666">.</span><span style="color: #7D9029">getSimpleName</span><span style="color: #666666">(),</span> <span style="color: #666666">1);</span>

            <span style="color: #408080; font-style: italic">// consumerProvider will instantiate a consumer that will create a KafkaStream</span>
            Map<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> List<span style="color: #666666">&lt;</span>KafkaStream<span style="color: #666666">&lt;</span><span style="color: #B00040">byte</span><span style="color: #666666">[],</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]&gt;&gt;&gt;</span> consumerMap
                    <span style="color: #666666">=</span> consumerProvider<span style="color: #666666">.</span><span style="color: #7D9029">consumer</span><span style="color: #666666">()</span>
                    <span style="color: #666666">.</span><span style="color: #7D9029">createMessageStreams</span><span style="color: #666666">(</span>topicCountMap<span style="color: #666666">);</span>

            <span style="color: #408080; font-style: italic">// then I will ask for the Stream from my topic, defined by Avro Record Class name</span>
            List<span style="color: #666666">&lt;</span>KafkaStream<span style="color: #666666">&lt;</span><span style="color: #B00040">byte</span><span style="color: #666666">[],</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]&gt;&gt;</span> streams <span style="color: #666666">=</span> consumerMap
                    <span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(</span>type<span style="color: #666666">.</span><span style="color: #7D9029">getSimpleName</span><span style="color: #666666">());</span>

            KafkaStream<span style="color: #666666">&lt;</span><span style="color: #B00040">byte</span><span style="color: #666666">[],</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]&gt;</span> stream <span style="color: #666666">=</span> streams<span style="color: #666666">.</span><span style="color: #7D9029">get</span><span style="color: #666666">(0);</span>

            ConsumerIterator<span style="color: #666666">&lt;</span><span style="color: #B00040">byte</span><span style="color: #666666">[],</span> <span style="color: #B00040">byte</span><span style="color: #666666">[]&gt;</span> it <span style="color: #666666">=</span> stream<span style="color: #666666">.</span><span style="color: #7D9029">iterator</span><span style="color: #666666">();</span>

            <span style="color: #408080; font-style: italic">// on each message published on topic, I will let the subscriber receive the new message</span>
            <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">(</span>it<span style="color: #666666">.</span><span style="color: #7D9029">hasNext</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
                subscriber<span style="color: #666666">.</span><span style="color: #7D9029">onNext</span><span style="color: #666666">(</span>
                        deserializer<span style="color: #666666">.</span><span style="color: #7D9029">deserialize</span><span style="color: #666666">(</span>it<span style="color: #666666">.</span><span style="color: #7D9029">next</span><span style="color: #666666">().</span><span style="color: #7D9029">message</span><span style="color: #666666">())</span>
                <span style="color: #666666">);</span>
            <span style="color: #666666">}</span>
        <span style="color: #666666">}</span> <span style="color: #008000; font-weight: bold">catch</span> <span style="color: #666666">(</span>Exception ex<span style="color: #666666">)</span> <span style="color: #666666">{</span>
            subscriber<span style="color: #666666">.</span><span style="color: #7D9029">onError</span><span style="color: #666666">(</span>ex<span style="color: #666666">);</span>
        <span style="color: #666666">}</span>
    <span style="color: #666666">});</span>
<span style="color: #666666">}</span>
</pre></div>


<p>You could check *Provider class to validate how to generate a connection to Kafka
for both Publisher and Subscriber.</p>

<p>On tag v0.0.3, you could run each class (KafkaEventServer and KafkaEventProducer)
to check that it&rsquo;s working Ok with your Kafka server.</p>

<h2 id="putting-all-together">Putting all together</h2>

<p><a href="https://github.com/jeqo/java-ee-rxjava-kafka-avro/releases/tag/v0.1.0">Tag: v0.1.0</a></p>

<p>Finally, let&rsquo;s integrate this Event Sourcing engine with our Java EE app:</p>

<p>First, create instantiate a publisher and a subscriber:</p>

<p><div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #AA22FF">@ApplicationScoped</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ClientAddedEventProducer</span> <span style="color: #008000; font-weight: bold">extends</span> KafkaEventProducer<span style="color: #666666">&lt;</span>ClientAddedEvent<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

<span style="color: #666666">}</span>
</pre></div>
</p>

<p>This means that ClientAddedEventProducer will be a <em>&ldquo;singleton&rdquo;</em> and I could inject it
on my service that generates events:</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ClientsResource</span> <span style="color: #666666">{</span>

    <span style="color: #AA22FF">@Inject</span>
    ClientAddedEventProducer eventProducer<span style="color: #666666">;</span>

    <span style="color: #408080; font-style: italic">//code</span>

    <span style="color: #AA22FF">@POST</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">addClient</span><span style="color: #666666">(</span>String client<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        clients<span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>client<span style="color: #666666">);</span>
        <span style="color: #408080; font-style: italic">//Publishing events</span>
        eventProducer<span style="color: #666666">.</span><span style="color: #7D9029">publish</span><span style="color: #666666">(</span>
                ClientAddedEvent<span style="color: #666666">.</span><span style="color: #7D9029">newBuilder</span><span style="color: #666666">()</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">setName</span><span style="color: #666666">(</span>client<span style="color: #666666">)</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">setCreated</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">new</span> Date<span style="color: #666666">().</span><span style="color: #7D9029">getTime</span><span style="color: #666666">())</span>
                <span style="color: #666666">.</span><span style="color: #7D9029">build</span><span style="color: #666666">()</span>
        <span style="color: #666666">);</span>
    <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>


<p>Then, instantiate a Subscriber (I think this is the most interesting part:
  how we will <strong>react</strong> to events? ):</p>

<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span></span><span style="color: #408080; font-style: italic">// Extending Subscriber RxJava class to listen Observables</span>
<span style="color: #AA22FF">@ApplicationScoped</span>
<span style="color: #008000; font-weight: bold">public</span> <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ClientAddedEventSubscriber</span> <span style="color: #008000; font-weight: bold">extends</span> Subscriber<span style="color: #666666">&lt;</span>ClientAddedEvent<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>

    <span style="color: #008000; font-weight: bold">static</span> <span style="color: #008000; font-weight: bold">final</span> Logger LOGGER <span style="color: #666666">=</span> Logger<span style="color: #666666">.</span><span style="color: #7D9029">getLogger</span><span style="color: #666666">(</span>ClientAddedEventSubscriber<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">.</span><span style="color: #7D9029">getName</span><span style="color: #666666">());</span>

    <span style="color: #408080; font-style: italic">// This will add a new thread to our pool, to subscribe to our Observable</span>
    <span style="color: #AA22FF">@Resource</span><span style="color: #666666">(</span>name <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;DefaultManagedExecutorService&quot;</span><span style="color: #666666">)</span>
    <span style="color: #008000; font-weight: bold">private</span> ManagedExecutorService executor<span style="color: #666666">;</span>

    <span style="color: #AA22FF">@Inject</span>
    <span style="color: #008000; font-weight: bold">private</span> KafkaConsumerProvider consumerProvider<span style="color: #666666">;</span>

    <span style="color: #008000; font-weight: bold">private</span> Subscription subscription<span style="color: #666666">;</span>

    <span style="color: #408080; font-style: italic">// Run this on server startup, using CDI annotations</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">init</span><span style="color: #666666">(</span><span style="color: #AA22FF">@Observes</span> <span style="color: #AA22FF">@Initialized</span><span style="color: #666666">(</span>ApplicationScoped<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span> Object init<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">log</span><span style="color: #666666">(</span>Level<span style="color: #666666">.</span><span style="color: #7D9029">INFO</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Starting subscription&quot;</span><span style="color: #666666">);</span>
        subscription <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">new</span> KafkaEventServer<span style="color: #666666">&lt;&gt;(</span>
                ClientAddedEvent<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">,</span>
                consumerProvider<span style="color: #666666">,</span>
                executor
        <span style="color: #666666">).</span><span style="color: #7D9029">consume</span><span style="color: #666666">().</span><span style="color: #7D9029">subscribe</span><span style="color: #666666">(</span><span style="color: #008000; font-weight: bold">this</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">destroy</span><span style="color: #666666">(</span><span style="color: #AA22FF">@Observes</span> <span style="color: #AA22FF">@Destroyed</span><span style="color: #666666">(</span>ApplicationScoped<span style="color: #666666">.</span><span style="color: #7D9029">class</span><span style="color: #666666">)</span> Object init<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        subscription<span style="color: #666666">.</span><span style="color: #7D9029">unsubscribe</span><span style="color: #666666">();</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onCompleted</span><span style="color: #666666">()</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> UnsupportedOperationException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Not supported yet.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onError</span><span style="color: #666666">(</span>Throwable e<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        <span style="color: #008000; font-weight: bold">throw</span> <span style="color: #008000; font-weight: bold">new</span> UnsupportedOperationException<span style="color: #666666">(</span><span style="color: #BA2121">&quot;Not supported yet.&quot;</span><span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

    <span style="color: #AA22FF">@Override</span>
    <span style="color: #008000; font-weight: bold">public</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">onNext</span><span style="color: #666666">(</span>ClientAddedEvent t<span style="color: #666666">)</span> <span style="color: #666666">{</span>
        LOGGER<span style="color: #666666">.</span><span style="color: #7D9029">log</span><span style="color: #666666">(</span>Level<span style="color: #666666">.</span><span style="color: #7D9029">INFO</span><span style="color: #666666">,</span> <span style="color: #BA2121">&quot;Event received {0}&quot;</span><span style="color: #666666">,</span> t<span style="color: #666666">);</span>
        <span style="color: #408080; font-style: italic">// How we will react to events:</span>
        EventsResource<span style="color: #666666">.</span><span style="color: #7D9029">events</span><span style="color: #666666">.</span><span style="color: #7D9029">add</span><span style="color: #666666">(</span>
                <span style="color: #BA2121">&quot;Client Added: &quot;</span> <span style="color: #666666">+</span> t<span style="color: #666666">.</span><span style="color: #7D9029">getName</span><span style="color: #666666">()</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; at &quot;</span> <span style="color: #666666">+</span> <span style="color: #008000; font-weight: bold">new</span> Date<span style="color: #666666">(</span>t<span style="color: #666666">.</span><span style="color: #7D9029">getCreated</span><span style="color: #666666">())</span>
        <span style="color: #666666">);</span>
    <span style="color: #666666">}</span>

<span style="color: #666666">}</span>
</pre></div>
</div>
        <div class="navbar">
        <ul class="navbar-list" style="...">
            
            <li class="navbar-item"><a class="navbar-link" href="https://github.com/jeqo/">GitHub</a></li>
            <li class="navbar-item"><a class="navbar-link" href="https://twitter.com/jeqo89">Twitter</a></li>
            <li class="navbar-item"><a class="navbar-link" href="index.xml">RSS</a></li>
        </ul>
    </div>
    <div class="copyright">
        <p>&copy; 2017. @jeqo. All rights reserved. </p>
    </div>
    

</div>
</body>
</html>

