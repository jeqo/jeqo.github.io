<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    
    
    <title>getting started with kafka quotas | @jeqo</title>
    
    
    
    <meta property="og:title" content="Getting started with Kafka quotas" />
    <meta name="twitter:title" content="Getting started with Kafka quotas" />
    
    
    <meta name="description" content="data streaming, observability, automation, and random stuff">
    <meta property="og:description" content="data streaming, observability, automation, and random stuff">
    <meta name="twitter:description" content="data streaming, observability, automation, and random stuff">
    

    <meta name="author" content="Jorge Esteban Quilcate Otoya" />
    <meta property="og:site_name" content="@jeqo" />
    <meta property="og:url" content="https://jeqo.github.io/posts/2022-05-11-kafka-quotas/" />
    
    <meta name="twitter:card" content="summary" />
    
    <meta name="twitter:site" content="@jeqo89" />
    <meta name="twitter:creator" content="@jeqo89" />
    
    
    <meta property="og:type" content="article" />
    

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" href="https://jeqo.github.io/css/style.css" />
    <link rel='icon' type='image/x-icon' href="https://jeqo.github.io/images/favicon.ico" />
    <script type="text/javascript" src="https://jeqo.github.io/js/bundle.js"></script>
    

</head>


<body>
    <a href="#main" class="skip-link p-screen-reader-text">Skip to content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;" aria-hidden="true">
    <symbol id="icon-feed" viewBox="0 0 16 16">
        <g>
            <path
                d="M2.13 11.733c-1.175 0-2.13.958-2.13 2.126 0 1.174.955 2.122 2.13 2.122a2.126 2.126 0 0 0 2.133-2.122 2.133 2.133 0 0 0-2.133-2.126zM.002 5.436v3.067c1.997 0 3.874.781 5.288 2.196a7.45 7.45 0 0 1 2.192 5.302h3.08c0-5.825-4.739-10.564-10.56-10.564zM.006 0v3.068C7.128 3.068 12.924 8.87 12.924 16H16C16 7.18 8.824 0 .006 0z" />
        </g>
    </symbol>
    <symbol id="icon-github" viewBox="0 0 16 16">
        <g>
            <path
                d="M8 .198a8 8 0 0 0-2.529 15.591c.4.074.547-.174.547-.385 0-.191-.008-.821-.011-1.489-2.226.484-2.695-.944-2.695-.944-.364-.925-.888-1.171-.888-1.171-.726-.497.055-.486.055-.486.803.056 1.226.824 1.226.824.714 1.223 1.872.869 2.328.665.072-.517.279-.87.508-1.07-1.777-.202-3.645-.888-3.645-3.954 0-.873.313-1.587.824-2.147-.083-.202-.357-1.015.077-2.117 0 0 .672-.215 2.201.82A7.672 7.672 0 0 1 8 4.066c.68.003 1.365.092 2.004.269 1.527-1.035 2.198-.82 2.198-.82.435 1.102.162 1.916.079 2.117.513.56.823 1.274.823 2.147 0 3.073-1.872 3.749-3.653 3.947.287.248.543.735.543 1.481 0 1.07-.009 1.932-.009 2.195 0 .213.144.462.55.384A8 8 0 0 0 8.001.196z" />
        </g>
    </symbol>
    <symbol id="icon-linkedin" viewBox="0 0 16 16">
        <g>
            <path
                d="M6 6h2.767v1.418h.04C9.192 6.727 10.134 6 11.539 6 14.46 6 15 7.818 15 10.183V15h-2.885v-4.27c0-1.018-.021-2.329-1.5-2.329-1.502 0-1.732 1.109-1.732 2.255V15H6V6zM1 6h3v9H1V6zM4 3.5a1.5 1.5 0 1 1-3.001-.001A1.5 1.5 0 0 1 4 3.5z" />
        </g>
    </symbol>
    <symbol id="icon-mail" viewBox="0 0 22 18">
        <g>
            <path fill="#000"
                d="M0 17.225V.776h22v16.447H0v.002zm3.011-1.815h15.978l-5.111-5.115L11 13.179l-2.877-2.883-5.112 5.114zm-1.216-1.275l5.077-5.09L1.795 3.98v10.155zm13.332-5.09l5.079 5.09V3.979l-5.079 5.066zm-4.126 1.588l8.022-8.027-16.045-.001 8.023 8.028z" />
        </g>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 16 16">
        <g>
            <path
                d="M15.504 13.616l-3.79-3.223c-.392-.353-.811-.514-1.149-.499a6 6 0 1 0-.672.672c-.016.338.146.757.499 1.149l3.223 3.79c.552.613 1.453.665 2.003.115s.498-1.452-.115-2.003zM6 10a4 4 0 1 1 0-8 4 4 0 0 1 0 8z" />
        </g>
    </symbol>
    <symbol id="icon-twitter" viewBox="0 0 16 16">
        <g>
            <path
                d="M16 3.538a6.461 6.461 0 0 1-1.884.516 3.301 3.301 0 0 0 1.444-1.816 6.607 6.607 0 0 1-2.084.797 3.28 3.28 0 0 0-2.397-1.034 3.28 3.28 0 0 0-3.197 4.028 9.321 9.321 0 0 1-6.766-3.431 3.284 3.284 0 0 0 1.015 4.381A3.301 3.301 0 0 1 .643 6.57v.041A3.283 3.283 0 0 0 3.277 9.83a3.291 3.291 0 0 1-1.485.057 3.293 3.293 0 0 0 3.066 2.281 6.586 6.586 0 0 1-4.862 1.359 9.286 9.286 0 0 0 5.034 1.475c6.037 0 9.341-5.003 9.341-9.341 0-.144-.003-.284-.009-.425a6.59 6.59 0 0 0 1.637-1.697z" />
        </g>
    </symbol>
    <symbol id="icon-keybase" viewBox="0 0 50 50">
        <g>
            <path
                d="M 24.433594 3.0019531 C 24.214219 3.0163281 23.998672 3.1032656 23.826172 3.2597656 C 23.70669 3.369165 22.227427 4.7384267 20.789062 6.9453125 C 20.493313 6.3897739 19.914285 6 19.25 6 L 14.75 6 C 13.794937 6 13 6.7949372 13 7.75 L 13 12.25 C 13 13.205063 13.794937 14 14.75 14 L 18.095703 14 C 18.038214 14.490889 18 14.988881 18 15.5 C 18 19.636 21.364 23 25.5 23 C 29.636 23 33 19.636 33 15.5 C 33 11.364 29.636 8 25.5 8 C 25.122 8 25.041812 7.8810781 25.007812 7.8300781 C 24.614813 7.2520781 24.999734 5.4491406 25.427734 4.3691406 C 25.599734 3.9371406 25.451359 3.4427344 25.068359 3.1777344 C 24.876359 3.0457344 24.652969 2.9875781 24.433594 3.0019531 z M 15 8 L 19 8 L 19 10.417969 C 18.803248 10.926943 18.627384 11.452559 18.480469 12 L 15 12 L 15 8 z M 16.646484 18.917969 C 9.2184844 22.402969 5 30.302 5 41 L 5 44 L 6.7246094 41.701172 C 7.0915267 43.013922 7.5755083 44.27612 8.1894531 45.460938 A 1.0002334 1.0002334 0 0 0 9.9648438 44.539062 C 9.1849975 43.034082 8.6252974 41.406022 8.3066406 39.693359 C 9.8157619 37.873526 11.472447 36.122537 13.066406 34.650391 C 12.538406 36.060391 12.183812 37.471953 12.007812 38.876953 L 11.693359 41.390625 L 13.640625 39.767578 C 13.696625 39.720578 19.437 35 26 35 C 29.219 35 30.97925 35.2985 32.53125 35.5625 C 33.86125 35.7875 35.118 36 37 36 C 40.1 36 41.797109 34.415625 42.537109 32.515625 C 42.734109 33.359625 42.872359 34.222563 42.943359 35.101562 C 42.979359 35.564563 43 36.03 43 36.5 C 43 39.318 42.33725 42.021062 41.03125 44.539062 C 40.77725 45.029063 40.968984 45.634672 41.458984 45.888672 C 41.605984 45.964672 41.764922 46 41.919922 46 C 42.280922 46 42.630594 45.804937 42.808594 45.460938 C 44.263594 42.656937 45 39.642 45 36.5 C 45 35.977 44.9785 35.456406 44.9375 34.941406 C 44.4555 28.783406 41.127547 23.350469 36.060547 20.105469 C 36.019547 20.079469 35.9785 20.051391 35.9375 20.025391 C 35.6015 19.814391 35.25625 19.615828 34.90625 19.423828 C 34.78325 19.355828 34.662109 19.285703 34.537109 19.220703 C 34.455109 19.177703 34.370109 19.140609 34.287109 19.099609 C 33.657109 20.630609 32.638469 21.961703 31.355469 22.970703 L 34.707031 26.322266 C 35.098031 26.713266 35.098031 27.345328 34.707031 27.736328 C 34.512031 27.931328 34.256 28.029297 34 28.029297 C 33.744 28.029297 33.487969 27.931328 33.292969 27.736328 L 32.455078 26.900391 L 30.648438 28.707031 C 30.453437 28.901031 30.197406 29 29.941406 29 C 29.685406 29 29.429375 28.902031 29.234375 28.707031 C 28.843375 28.316031 28.843375 27.683969 29.234375 27.292969 L 31.042969 25.484375 L 30 24.443359 L 28.707031 25.736328 C 28.512031 25.931328 28.256 26.029297 28 26.029297 C 27.744 26.029297 27.487969 25.931328 27.292969 25.736328 C 27.056969 25.500328 26.981297 25.178047 27.029297 24.873047 C 26.531297 24.954047 26.021 25 25.5 25 C 21.467 25 18.022484 22.470969 16.646484 18.917969 z M 20.5 40 A 1.5 1.5 0 0 0 19 41.5 A 1.5 1.5 0 0 0 20.5 43 A 1.5 1.5 0 0 0 22 41.5 A 1.5 1.5 0 0 0 20.5 40 z M 31.5 40 A 1.5 1.5 0 0 0 30 41.5 A 1.5 1.5 0 0 0 31.5 43 A 1.5 1.5 0 0 0 33 41.5 A 1.5 1.5 0 0 0 31.5 40 z" />
        </g>
    </symbol>
    <symbol id="icon-youtube" viewBox="0 0 16 16">
        <g>
            <path
                d="M15.841 4.8s-.156-1.103-.637-1.587c-.609-.637-1.291-.641-1.603-.678-2.237-.163-5.597-.163-5.597-.163h-.006s-3.359 0-5.597.163c-.313.038-.994.041-1.603.678C.317 3.697.164 4.8.164 4.8S.005 6.094.005 7.391v1.213c0 1.294.159 2.591.159 2.591s.156 1.103.634 1.588c.609.637 1.409.616 1.766.684 1.281.122 5.441.159 5.441.159s3.363-.006 5.6-.166c.313-.037.994-.041 1.603-.678.481-.484.637-1.588.637-1.588s.159-1.294.159-2.591V7.39c-.003-1.294-.162-2.591-.162-2.591zm-9.494 5.275V5.578l4.322 2.256-4.322 2.241z" />
        </g>
    </symbol>
</svg>
    <header class="l-header">
        
        <p class="c-title p-title"><a href="https://jeqo.github.io/" class="p-title__link">@jeqo</a></p>
         
        <p class="p-subtitle">
            data streaming, observability, automation, and random stuff
        </p>
        
    </header>
    
<ul class="c-links">
  
  <li class="c-links__item">
    <a href="https://twitter.com/jeqo89" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>twitter</title>
        <use xlink:href="#icon-twitter"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://github.com/jeqo" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>github</title>
        <use xlink:href="#icon-github"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://keybase.io/jeqo" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>linkedin</title>
        <use xlink:href="#icon-keybase"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://linkedin.com/in/jeqo89" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>linkedin</title>
        <use xlink:href="#icon-linkedin"></use>
      </svg>
    </a>
  </li>
  
</ul>

 
<nav class="l-nav p-menu">
    <ul class="p-menu__lists">
         
        <li class="p-menu__listitem">
            <a href="/posts">Posts</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/notes">Notes</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/talks">Talks</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/projects">Projects</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/about">About</a>
        </li>
          
    </ul>
</nav>

    <main id="main" class="l-main">

<article class="p-article">
  
  <header>
    
    <a href="https://jeqo.github.io/posts" class="c-tag">posts</a>
    
    <h1>Getting started with Kafka quotas</h1>
    <div>
      <div class="c-time">
        Posted on
        <time datetime="2022-05-11T00:00:00Z">
          May 11, 2022
        </time>
      </div>
      
      
      <a href="https://jeqo.github.io/tags/kafka" class="c-tag">kafka</a>
      
      <a href="https://jeqo.github.io/tags/ops" class="c-tag">ops</a>
      
    </div>
  </header>
  
  <section id="js-article" class="p-article__body">
    <p>Kafka quotas have been around for a while since initial versions of the project — though not necessarily being enabled in most deployments that I have seen.</p>
<p>This post shares some thoughts on how to start adopting quotas and gives some practical advice, and a bit of the history of quotas in the Kafka project.</p>
<h2 id="why-quotas-are-important">
    <a class="hash-link nohover" href="#why-quotas-are-important">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Why quotas are important?
</h2>
<p>Once more than 1 team / use-case start to share a Kafka cluster, there is an increasing need to avoid having any of the tenants over-consuming or monopolizing the cluster resources available.
This is the role of Kafka quotas.</p>
<p>This doesn&rsquo;t necessarily mean having quotas for each and every application though, but it can start with a good default quotas definition for all applications, and then extend them only for the outliers.
If you think about it, you may only need to define <em>1</em> quota to get started; and just add new ones for the outliers — applications needing more (or maybe less?) than the defaults.</p>
<p>This default quotas represents an initial SLA for customers: &ldquo;these are the default ingress and egress bandwidth your application will be allowed to use by default&rdquo;.
If this is enough – and the goal is to make the defaults <em>good</em> enough to avoid getting every tenant to request more resources — then there is no need for additional quotas.
Only the outliers that require higher bandwidth will need additional quotas for their users.</p>
<p>Keep in mind that when quotas are reached, the behavior is to throttle — not to fail.
Tenants have to weigh on this to accept a certain quota limit.</p>
<h2 id="how-do-start-adopting-the-usage-of-quotas">
    <a class="hash-link nohover" href="#how-do-start-adopting-the-usage-of-quotas">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;How do start adopting the usage of quotas?
</h2>
<h3 id="identify-broker-resources-to-constraint">
    <a class="hash-link nohover" href="#identify-broker-resources-to-constraint">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Identify broker resources to constraint
</h3>
<p>Understanding the Kafka request lifecycle helps us to identify the resource to constraint:</p>
<p><img alt="img.png" src="/posts/2022-05-11-kafka-quotas/request-lifecycle.png"></p>
<blockquote>
<p>Source: <a href="https://developer.confluent.io/#kafka-internals">https://developer.confluent.io/#kafka-internals</a></p>
</blockquote>
<p>To start with, there is the read and write <strong>throughput bandwidth</strong> (i.e. produce/fetch rate) between clients and brokers.
This metric is driven by the amount of data moved, and it&rsquo;s the first, most common, quota to enforce.</p>
<p>This volume of data can be moved in many (potentially batched) requests.
The number of requests impacts the processing load required on the brokers.
Kafka brokers have 2 main thread pools to process requests: network threads and IO threads.
These <strong>thread pools</strong> are the second resource to operate.</p>
<p>Then, the <strong>connections created</strong> between clients and brokers is the third one.
Clients open connections with a certain frequency.
Having an upper bound on the number of connections created helps to reduce the chances for denial-of-service attacks.</p>
<p>Additionally, there are replication and controller mutation quotas that are for inter-broker communication.
I won&rsquo;t dive into these as I haven&rsquo;t used them in the past. Though, consider that these become important when re-balancing a cluster.</p>
<p>Estimating the rough amount of resources available per broker is a good exercise, though it can be hard to calculate.</p>
<p>For throughput bandwidth (read/write), the network bandwidth is the resource, and it&rsquo;s shared by the OS processes, broker control plane (admin operations), and the data plane (read/write) <em>including replication</em>.</p>
<p>For processing rates, the formula is defined as <code>((num.io.threads + num.network.threads) * 100)%.</code>. By default, there are 8 IO threads and 3 network threads, leading to 11,000 processing units to allocate.
Assuming the broker has 12 CPUs, then each processing unit can represent a milli-CPU.</p>
<p>Connections created limit is more about finding a sensible number.</p>
<h3 id="identify-applications">
    <a class="hash-link nohover" href="#identify-applications">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Identify applications
</h3>
<p>Kafka clients can be identified by 2 metadata values:</p>
<ul>
<li><code>client.id</code>: optional configuration property to identify client.</li>
<li><code>user</code>: User principal authenticated, e.g. Common name.</li>
</ul>
<p>Both metadata values can be mixed to identify an application.
User metadata tends to be easier to apply as if the cluster is secured then the value is always available.
With <code>client.id</code> it is more difficult as there is no out-of-the-box option to enforce it.</p>
<p>Following the usage of user principal as the application identifier, it depends on how the credentials are used across the applications within a domain.</p>
<p>These are the scenarios I have seen more in the field:</p>
<p>Let&rsquo;s say there is a Change Data Capture team running multiple connectors,</p>
<ul>
<li>Are credentials provided for the whole domain or per connector?</li>
<li>If the credentials are provided per connector, then it&rsquo;s easier to apply quotas as each connector is independent, and the <code>user</code> can be used as a way to identify applications.</li>
<li>If credentials are shared, then:
<ul>
<li>Are quotas applicable for the whole domain? or it&rsquo;s required to apply it per connector/component?</li>
<li>If quotas are applicable per domain, then the <code>user</code> can then be used independently.</li>
<li>If quotas are applicable per component, then the <code>user</code> and <code>client.id</code> can be used as a pair to identify</li>
</ul>
</li>
</ul>
<p>In summary, assuming the cluster is secured, there are 2 ways to approach quotas:</p>
<ol>
<li>Using <code>user</code> principal only: easier to manage though require to have credentials per component.</li>
<li>Using <code>user</code> principal and <code>client.id</code>. When using this option, set up a specific <code>user</code> with default <code>client-id</code>. Avoid relying on client-id value.</li>
</ol>
<h3 id="define-_good_-defaults">
    <a class="hash-link nohover" href="#define-_good_-defaults">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Define <em>good</em> defaults
</h3>
<p>Defaults will depend on how applications are identified.
Kafka comes with a hierarchy to apply quotas:</p>
<pre><code>1. /config/users/&lt;user&gt;/clients/&lt;client-id&gt;
2. /config/users/&lt;user&gt;/clients/&lt;default&gt; (**)
3. /config/users/&lt;user&gt; (*)
4. /config/users/&lt;default&gt;/clients/&lt;client-id&gt;
5. /config/users/&lt;default&gt;/clients/&lt;default&gt; (**)
6. /config/users/&lt;default&gt; (*)
7. /config/clients/&lt;client-id&gt;
8. /config/clients/&lt;default&gt;
</code></pre>
<p>If <code>user</code> principal is enough to identify clients (approach 1.), then use (*) 6. first, for all/default users; and 3. for specific users.</p>
<p>On the other hand, if user principal is shared and quotas apply per component (approach 2.), the use (**) 5. first, for all applications; and 2. for all components under a user principal.</p>
<p>The purpose of the initial quota for all users (*) or for all components (**) is to define the default SLA for Kafka applications.
In a multi-tenant environment, this is very useful.
The goal of these defaults is to cover most (e.g. ~80%) of your applications and only add specific quotas for the outliers.
If the defaults are <em>too</em> low, then applications will need to be micromanaged, increasing the complexity to operate quotas.</p>
<p>Either way, try to stick to one way to identify applications across a cluster.
This will simplify managing quotas, knowing which quota applies to a specific application and provide the right metrics.</p>
<p>Confluent Cloud Bandwidth limits per partition represent a good default in my view: <code>Write=5MB/s</code>, <code>Read=15MB/s</code>.</p>
<blockquote>
<p>Note about Confluent Cloud: The scope of quotas in Apache Kafka is a broker. However, in Confluent Cloud, limits are applied per Cluster and Partition <a href="https://docs.confluent.io/cloud/current/clusters/cluster-types.html">https://docs.confluent.io/cloud/current/clusters/cluster-types.html</a></p>
</blockquote>
<p>The processing rate quotas are a bit harder to specify in my experience as it depends on the processing power available on the brokers (i.e. number of CPUs).
A potentially good default value could be <code>1000</code> — assuming 1 thread/1 CPU relation — to state that a client can at most use 1 CPU.
Batching requests for high-load clients tends to be a good way to reduce processing demand by reducing the number of requests.</p>
<p>For connections created, Confluent Cloud is also a good reference: 250 is the maximum number of requests that could be created.</p>
<h3 id="monitor-application-quotas">
    <a class="hash-link nohover" href="#monitor-application-quotas">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Monitor application quotas
</h3>
<p>One very interesting effect of enabling quotas is that a new set of metrics are enabled on the brokers.
These metrics start to track: resources used by applications and throttling.</p>
<p>If these metrics are collected, then applications can be monitored from the broker side, reducing the need to monitor each application — which is still recommended but involved much more work.</p>
<p>Make sure to stick to one way to identify applications.
If quotas are applied to different identifiers (e.g. client-id, and on the other hand user) then the metrics will be harder to understand.</p>
<h3 id="adjust-quotas--scale-cluster">
    <a class="hash-link nohover" href="#adjust-quotas--scale-cluster">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Adjust quotas / Scale cluster
</h3>
<p>Quotas are controlled individually at the broker, without coordination with other brokers.
This means that if an application is writing data to multiple partitions across different brokers, the quotas will only be collected per broker and validated on that scope.
If new brokers are added to the cluster, and the cluster is rebalanced, the quotas will still be applied per individual broker.</p>
<p>Hypothetically, if the cluster is large enough then a broker could be hosting one partition, and the quotas will apply to that one partition.
This is why I think the Confluent Cloud limits per partition are a valid reference.</p>
<p>By monitoring application quotas and throttling, operators can identify —even proactively— applications that are reaching limits and may require higher quota limits or scaling the cluster to reduce the partitions allocated per broker when rebalanced.</p>
<h2 id="bonus-kfk-quotas-a-cli-to-manage-quotas">
    <a class="hash-link nohover" href="#bonus-kfk-quotas-a-cli-to-manage-quotas">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Bonus: `kfk-quotas`, a CLI to manage quotas
</h2>
<p>KIP-546 is supposed to add a new —and better— CLI to manage Quotas.
At the moment the CLI to manage quotas is included as part of <code>kafka-configs</code> which is not the most user-friendly tool for this specific entity.</p>
<p>Therefore, I created a single CLI to manage quotas: <a href="https://github.com/jeqo/poc-apache-kafka/tree/main/cli/quotas">https://github.com/jeqo/poc-apache-kafka/tree/main/cli/quotas</a></p>
<p>Following the first (identifying applications only by user), here is a demo:</p>
<ol>
<li>Create default quota:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kfk-quotas create --kafka cp-demo <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  --user-default <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  --produce-rate <span style="color:#666">5000000</span> --fetch-rate <span style="color:#666">15000000</span>
</span></span></code></pre></div><ol start="2">
<li>Get list of quotas:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kfk-quotas query --kafka cp-demo 2&gt; /dev/null | jq .
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;clientEntity&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;user&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b44">&#34;default&#34;</span>: <span style="color:#a2f">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;constraints&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;producer_byte_rate&#34;</span>: 5000000,
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;consumer_byte_rate&#34;</span>: <span style="color:#666">15000000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span><span style="color:#666">]</span>
</span></span></code></pre></div><ol start="3">
<li>Check application quota metrics:</li>
</ol>
<p><img alt="Quota metrics" src="/posts/2022-05-11-kafka-quotas/quotas_1.png"></p>
<ol start="4">
<li>Apply a specific metric for a user:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kfk-quotas create --kafka cp-demo <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  --user controlcenterAdmin <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>  --produce-rate <span style="color:#666">10000</span> --fetch-rate <span style="color:#666">60000</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kfk-quotas query --kafka cp-demo 2&gt; /dev/null | jq
</span></span><span style="display:flex;"><span><span style="color:#666">[</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;clientEntity&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;user&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b44">&#34;default&#34;</span>: <span style="color:#a2f">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;constraints&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;producer_byte_rate&#34;</span>: 5000000,
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;consumer_byte_rate&#34;</span>: <span style="color:#666">15000000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;clientEntity&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;user&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#b44">&#34;user&#34;</span>: <span style="color:#b44">&#34;controlcenterAdmin&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#b44">&#34;constraints&#34;</span>: <span style="color:#666">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;producer_byte_rate&#34;</span>: 10000,
</span></span><span style="display:flex;"><span>      <span style="color:#b44">&#34;consumer_byte_rate&#34;</span>: <span style="color:#666">60000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#666">}</span>
</span></span><span style="display:flex;"><span><span style="color:#666">]</span>
</span></span></code></pre></div><ol start="5">
<li>And check that throttling starts to kick in:</li>
</ol>
<p><img alt="Quota metrics with throttling" src="/posts/2022-05-11-kafka-quotas/quotas_2.png"></p>
<p>This short demo captures most of the workflow on how to adopt quotas:</p>
<ul>
<li>Define defaults depending on your applications identifiers.</li>
<li>Monitor resources used by application</li>
<li>Apply specific quotas for outliers, and iterate.</li>
</ul>
<h2 id="appendix-quotas-history">
    <a class="hash-link nohover" href="#appendix-quotas-history">
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
	<svg width="20px" height="20px" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg"><g id="bb4ed7a9-727c-433e-a92a-fb7b8fd366b0" data-name="Layer 3"><path d="M32,12H25.34l1.55-7.74a1,1,0,0,0-2-.39L23.3,12H15.11l1.55-7.74a1,1,0,0,0-2-.39L13.07,12H6a1,1,0,0,0,0,2h6.67l-1.6,8H4a1,1,0,0,0,0,2h6.66L9.11,31.74a1,1,0,0,0,.79,1.17.68.68,0,0,0,.2,0,1,1,0,0,0,1-.8L12.7,24h8.19l-1.55,7.74a1,1,0,0,0,.79,1.17.62.62,0,0,0,.19,0,1,1,0,0,0,1-.8L22.93,24H30a1,1,0,0,0,0-2H23.33l1.61-8H32a1,1,0,0,0,0-2ZM21.29,22H13.1l1.61-8H22.9Z"/></g></svg>
	
    </a>&nbsp;Appendix: Quotas history
</h2>
<p>Quotas have been available in Apache Kafka from very early versions:</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-13+-+Quotas">KIP-13: Quota Design</a> was adopted in the release <code>0.9.0</code>.
It included setting quotas by using <code>client.id</code>, and only for <code>bandwidth</code> (i.e. produce and fetch bytes per second).
It already includes the concept of <em>default</em> quotas which would apply to every application, and also mentions the use of metrics to measure bandwidth per client.</li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-55%3A+Secure+Quotas+for+Authenticated+Users">KIP-55: Secure Quotas for Authenticated Users</a> —adopted in the release <code>0.10.1</code>— brings the concept User principals to identify applications.
This is an important enhancement as it <code>client.id</code> is an optional configuration and hard to enforce.
With User principals, we already have this metadata available on the secured cluster.
It also defines the order of precedence that applies even today:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    /config/users/&lt;user&gt;/clients/&lt;client-id&gt;
</span></span><span style="display:flex;"><span>    /config/users/&lt;user&gt;/clients/&lt;default&gt; (**)
</span></span><span style="display:flex;"><span>    /config/users/&lt;user&gt; (*)
</span></span><span style="display:flex;"><span>    /config/users/&lt;default&gt;/clients/&lt;client-id&gt;
</span></span><span style="display:flex;"><span>    /config/users/&lt;default&gt;/clients/&lt;default&gt; (**)
</span></span><span style="display:flex;"><span>    /config/users/&lt;default&gt; (*)
</span></span><span style="display:flex;"><span>    /config/clients/&lt;client-id&gt;
</span></span><span style="display:flex;"><span>    /config/clients/&lt;default&gt;
</span></span></code></pre></div><ul>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-73+Replication+Quotas">KIP-73: Replication Quotas</a> —adopted since <code>0.10.1</code>— adds quotas to limit the resources used by inter-broker replication.</li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-124+-+Request+rate+quotas">KIP-124: Request rate quotas</a> —since <code>0.11.0</code>— introduce the concept of processing rate quotas to limit the amount of thread time used by an application.</li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-219+-+Improve+quota+communication">KIP-219: Improve quota communication</a> —since <code>2.0</code>— improves the feedback loop to reply faster to clients when the broker identifies limits are reached.</li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-257+-+Configurable+Quota+Management">KIP-257: Configurable Quota Management</a> —<code>2.0</code>— deprecates the definition of quotas on the configuration file.</li>
<li><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-546%3A+Add+Client+Quota+APIs+to+the+Admin+Client">KIP-546: Add Client Quota APIs to the Admin Client</a> —most recently introduced in <code>2.6</code> release— improves the client APIs for managing quotas, and promises to introduce a new CLI for quotas management.</li>
</ul>
  </section>
  <footer>
    
<div id="disqus_thread"></div>

<script src="https://giscus.app/client.js"
        data-repo="jeqo/jeqo.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk3ODM0ODMyMQ=="
        data-category="Announcements"
        data-category-id="DIC_kwDOBKuAIc4CP1oE"
        data-mapping="title"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>


    <nav class="p-pagination c-pagination">
      <div class="c-pagination__ctrl">
        <div class="c-pagination__newer">
          
          <a href="https://jeqo.github.io/notes/2022-05-09-sqlite-as-document-and-graph-db/">Newer</a>
          
        </div>
        <div class="c-pagination__older">
          
          <a href="https://jeqo.github.io/posts/2022-06-17-kafka-streams-tick-event-time-with-control-messages/">Older</a>
          
        </div>
      </div>
    </nav>
    

<section class="p-related">
  <h3>See Also</h3>
  <ul id="slider" class="p-related__list">
    
    <li class="p-related__item js-related__item">
      <a href="/notes/2022-02-09-kafka-ssl-crl/"
        >
        <span>Enable Certificate Revocation on Kafka clusters</span>
      </a>
    </li>
    
    <li class="p-related__item js-related__item">
      <a href="/notes/2021-12-10-kafka-change-rack/"
        >
        <span>Changing Kafka Broker&#39;s rack</span>
      </a>
    </li>
    
    <li class="p-related__item js-related__item">
      <a href="/posts/2021-12-10-kafka-data-loss/"
        >
        <span>Kafka data loss scenarios</span>
      </a>
    </li>
    
    <li class="p-related__item js-related__item">
      <a href="/notes/2021-12-09-kafka-reducing-acks-and-latency/"
        >
        <span>Reducing `acks` doesn&#39;t help to reduce end-to-end latency</span>
      </a>
    </li>
    
    <li class="p-related__item js-related__item">
      <a href="/notes/2021-12-02-kafka-min-isr/"
        >
        <span>Use min.insync.replicas for fault-tolerance</span>
      </a>
    </li>
    
    <li class="p-related__item js-related__item">
      <a href="/posts/2022-03-18-kafka-clients-graalvm/"
        >
        <span>Kafka client applications with GraalVM</span>
      </a>
    </li>
    
  </ul>
</section>


  </footer>
</article>
  </main>
  
<nav class="l-nav p-menu">
    <ul class="p-menu__lists">
         
        <li class="p-menu__listitem">
            <a href="/posts">Posts</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/notes">Notes</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/talks">Talks</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/projects">Projects</a>
        </li>
          
        <li class="p-menu__listitem">
            <a href="/about">About</a>
        </li>
          
    </ul>
</nav>

  <footer class="l-footer">
    
<ul class="c-links">
  
  <li class="c-links__item">
    <a href="https://twitter.com/jeqo89" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>twitter</title>
        <use xlink:href="#icon-twitter"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://github.com/jeqo" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>github</title>
        <use xlink:href="#icon-github"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://keybase.io/jeqo" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>linkedin</title>
        <use xlink:href="#icon-keybase"></use>
      </svg>
    </a>
  </li>
  
  
  <li class="c-links__item">
    <a href="https://linkedin.com/in/jeqo89" target="_blank">
      <svg viewBox="0 0 64 64" class="c-links__icon">
        <title>linkedin</title>
        <use xlink:href="#icon-linkedin"></use>
      </svg>
    </a>
  </li>
  
</ul>



    <p class="p-copyright">This work is licensed under <a
        href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank"
        rel="license noopener noreferrer" style="display:inline-block;">CC BY 4.0<img
        style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
        src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img
        style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
        src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a>

      &nbsp;&bull;&nbsp;
      2024

      
        &nbsp;&bull;&nbsp;
        <a href="https://jeqo.github.io/">@jeqo</a>
      
      &nbsp;&bull;&nbsp;
      <a href="https://github.com/jeqo/jeqo.github.io-src">[source code]</a>
    </p>
  </footer>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49047812-3', 'auto');
    ga('send', 'pageview');
  </script>
  

</body>
</html>

